<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ClimbChess ‚Äî Train Smarter</title>
  <style>
    :root{
      --bg:#0b0f17;
      --card:#121a2a;
      --card2:#0f1626;
      --text:#e9eefc;
      --muted:#aab3d0;
      --brand:#7c5cff;
      --brand2:#37d4ff;
      --good:#36d399;
      --bad:#fb7185;
      --warn:#fbbf24;
      --stroke:rgba(255,255,255,.10);
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 500px at 10% 10%, rgba(124,92,255,.25), transparent 60%),
        radial-gradient(900px 500px at 90% 30%, rgba(55,212,255,.18), transparent 60%),
        linear-gradient(180deg, #070a11, var(--bg));
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:28px;}
    .nav{
      display:flex;align-items:center;justify-content:space-between;
      gap:16px; position:sticky; top:0; z-index:10;
      padding:14px 0;
      background: linear-gradient(180deg, rgba(11,15,23,.95), rgba(11,15,23,.65), transparent);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px
    }
    .logo{
      width:34px;height:34px;border-radius:12px;
      background: conic-gradient(from 210deg, var(--brand), var(--brand2), var(--brand));
      box-shadow: 0 10px 30px rgba(124,92,255,.25);
    }
    .nav .btnrow{display:flex;gap:10px;align-items:center}
    .btn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 14px;border-radius:14px;
      cursor:pointer;font-weight:700;
      transition:.2s transform, .2s background;
      display:inline-flex;align-items:center;gap:8px;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.10)}
    .btn.primary{
      border:0;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      color:#06101a;
    }
    .btn.ghost{background:transparent}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-weight:700;
    }
    .hero{
      display:grid;grid-template-columns:1.2fr .8fr;gap:18px;
      padding:22px 0 10px;
    }
    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(18,26,42,.95), rgba(15,22,38,.92));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card.pad{padding:20px}
    h1{margin:10px 0 8px;font-size:44px;line-height:1.04}
    .sub{color:var(--muted);font-size:16px;line-height:1.5;max-width:58ch}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:16px}
    .feat{
      padding:14px;border-radius:16px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
    }
    .feat b{display:block;margin-bottom:4px}
    .tag{
      font-family:var(--mono);
      font-size:12px;color:rgba(255,255,255,.75);
      background:rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      padding:6px 8px;border-radius:10px;display:inline-block;
    }
    .app{
      display:none;
      margin-top:18px;
      grid-template-columns:330px 1fr;
      gap:16px;
      align-items:start;
    }
    .sidebar{position:sticky;top:70px}
    .sideTop{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .sideUser{
      display:flex;flex-direction:column;gap:4px;margin-top:10px;
      padding:12px;border-radius:16px;border:1px solid var(--stroke);background:rgba(255,255,255,.03)
    }
    .sideUser small{color:var(--muted)}
    .menu{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .menu .btn{justify-content:flex-start;width:100%}
    .content{display:grid;gap:16px}
    .sectionTitle{display:flex;justify-content:space-between;align-items:flex-end;gap:10px}
    .sectionTitle h2{margin:0;font-size:22px}
    .sectionTitle p{margin:0;color:var(--muted);font-size:13px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .kpi{
      display:flex;flex-direction:column;gap:6px;
      padding:14px;border-radius:16px;border:1px solid var(--stroke);background:rgba(255,255,255,.04)
    }
    .kpi .big{font-size:24px;font-weight:900}
    .kpi small{color:var(--muted)}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:700}
    input, select, textarea{
      width:100%;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.22);
      color:var(--text);
      padding:11px 12px;
      border-radius:14px;
      outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    .hr{height:1px;background:var(--stroke);margin:14px 0}
    .notice{
      padding:12px 12px;border-radius:14px;border:1px solid var(--stroke);
      background:rgba(55,212,255,.07);
      color:rgba(233,238,252,.92);
      font-size:13px;line-height:1.35
    }
    .notice.good{background:rgba(54,211,153,.08)}
    .notice.bad{background:rgba(251,113,133,.08)}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .choices{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .choice{
      padding:12px;border-radius:14px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      cursor:pointer;font-weight:900;
      transition:.15s transform, .15s background;
      user-select:none;
      text-align:center;
    }
    .choice:hover{transform:translateY(-1px);background:rgba(255,255,255,.07)}
    .choice.correct{border-color:rgba(54,211,153,.7);background:rgba(54,211,153,.08)}
    .choice.wrong{border-color:rgba(251,113,133,.7);background:rgba(251,113,133,.08)}
    .board{
      width:100%; max-width:420px;
      aspect-ratio:1/1;
      border-radius:18px;
      overflow:hidden;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      display:grid;
      grid-template-columns:repeat(8,1fr);
    }
    .sq{
      display:flex;align-items:center;justify-content:center;
      font-size:28px;
      font-family: "Segoe UI Symbol", "Apple Color Emoji", var(--sans);
      position:relative;
    }
    .sq.dark{background:rgba(255,255,255,.06)}
    .coord{
      position:absolute;left:6px;bottom:4px;font-size:10px;
      color:rgba(255,255,255,.55);font-family:var(--mono);font-weight:800
    }
    .footer{
      margin-top:26px;
      padding:20px 0;
      color:rgba(255,255,255,.55);
      font-size:12px;
    }
    @media (max-width: 980px){
      .hero{grid-template-columns:1fr}
      .app{grid-template-columns:1fr}
      .sidebar{position:relative;top:auto}
      .row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="nav">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div style="font-size:15px">ClimbChess</div>
          <div style="font-size:11px;color:var(--muted);font-weight:700">AI training that actually sticks</div>
        </div>
      </div>
      <div class="btnrow">
        <span class="pill" id="modePill">Landing</span>
        <button class="btn ghost" id="btnDemo">Open Demo</button>
        <button class="btn primary" id="btnStart">Start Training</button>
      </div>
    </div>

    <!-- LANDING -->
    <section id="landing">
      <div class="hero">
        <div class="card pad">
          <span class="tag">MVP website ‚Ä¢ no backend required</span>
          <h1>Get better at chess with <span style="background:linear-gradient(135deg,var(--brand),var(--brand2));-webkit-background-clip:text;background-clip:text;color:transparent">focused practice</span>.</h1>
          <p class="sub">
            ClimbChess is a training hub that turns your weak points into short daily drills:
            puzzles, openings, endgames, and a study plan that fits your schedule.
          </p>

          <div class="grid2">
            <div class="feat">
              <b>Daily Puzzle</b>
              <div class="muted">Quick tactics with ‚Äúwhy‚Äù explanations and tracking.</div>
            </div>
            <div class="feat">
              <b>Study Plan Generator</b>
              <div class="muted">A weekly plan based on rating + time + goals.</div>
            </div>
            <div class="feat">
              <b>Opening Flashcards</b>
              <div class="muted">Spaced repetition for key lines & ideas.</div>
            </div>
            <div class="feat">
              <b>Progress Dashboard</b>
              <div class="muted">Streaks, accuracy, and personal notes.</div>
            </div>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:16px">
            <button class="btn primary" id="btnStart2">Start Training</button>
            <button class="btn" id="btnPitch">Show Product Pitch</button>
            <button class="btn" id="btnReset">Reset Demo Data</button>
          </div>
        </div>

        <div class="card pad">
          <div class="sectionTitle">
            <div>
              <h2>What your AI can do next</h2>
              <p>Hooks included ‚Äî plug in Lichess/Stockfish later.</p>
            </div>
          </div>
          <div class="hr"></div>
          <ul class="muted" style="margin:0;padding-left:18px;line-height:1.7">
            <li><b>Personal coaching chat</b> (explain mistakes from your games).</li>
            <li><b>Auto puzzle selection</b> based on blunders (forks, pins, back rank).</li>
            <li><b>Opening repertoire builder</b> from PGN imports.</li>
            <li><b>‚ÄúOne concept at a time‚Äù lessons</b> (fast + sticky).</li>
          </ul>
          <div class="hr"></div>
          <div class="notice">
            Tip: Start with a single niche (e.g., <b>800‚Äì1400 rapid players</b>) and nail
            ‚Äútactics + explanation + streak‚Äù before you add everything.
          </div>
        </div>
      </div>
    </section>

    <!-- APP -->
    <section class="app" id="app">
      <aside class="sidebar">
        <div class="card pad">
          <div class="sideTop">
            <div>
              <div style="font-weight:900;font-size:16px">Training Hub</div>
              <div class="muted" style="font-size:12px">Personalized drills</div>
            </div>
            <span class="tag" id="streakTag">streak: 0</span>
          </div>

          <div class="sideUser">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
              <b id="userName">Guest</b>
              <span class="tag" id="userRatingTag">rating: 1200</span>
            </div>
            <small id="userGoal">Goal: Improve tactics & endgames</small>
          </div>

          <div class="menu">
            <button class="btn" data-view="dashboard">üìà Dashboard</button>
            <button class="btn" data-view="puzzle">üß© Daily Puzzle</button>
            <button class="btn" data-view="plan">üóìÔ∏è Study Plan</button>
            <button class="btn" data-view="openings">üìö Openings</button>
            <button class="btn" data-view="settings">‚öôÔ∏è Settings</button>
            <button class="btn ghost" id="btnBack">‚Üê Back to Landing</button>
          </div>
        </div>
      </aside>

      <main class="content">

        <!-- DASHBOARD -->
        <div class="card pad view" id="view-dashboard">
          <div class="sectionTitle">
            <div>
              <h2>Dashboard</h2>
              <p>Your week at a glance.</p>
            </div>
            <button class="btn primary" id="btnQuickPuzzle">Do today‚Äôs puzzle</button>
          </div>

          <div class="row" style="margin-top:14px">
            <div class="kpi">
              <div class="muted">Puzzle accuracy</div>
              <div class="big" id="kpiAccuracy">‚Äî</div>
              <small class="muted">Based on your attempts</small>
            </div>
            <div class="kpi">
              <div class="muted">Sessions this week</div>
              <div class="big" id="kpiSessions">‚Äî</div>
              <small class="muted">Keep it short + consistent</small>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div>
              <b>Notes to self</b>
              <p class="muted" style="margin-top:6px">
                What patterns are beating you lately? (Pins, hanging pieces, time trouble, etc.)
              </p>
              <textarea id="notes" placeholder="Example: Stop autopiloting in the opening. Check for tactics every move."></textarea>
              <div style="display:flex;gap:10px;margin-top:10px">
                <button class="btn primary" id="btnSaveNotes">Save notes</button>
                <button class="btn" id="btnClearNotes">Clear</button>
              </div>
            </div>

            <div>
              <b>Today‚Äôs focus</b>
              <div class="notice" style="margin-top:10px" id="todayFocus"></div>
              <div class="hr"></div>
              <b>Micro-drill (2 minutes)</b>
              <div class="muted" style="margin-top:6px;line-height:1.5">
                Before every move, ask:
                <div class="mono" style="margin-top:8px">
                  1) What is my opponent threatening?<br/>
                  2) What checks/captures/threats do I have?<br/>
                  3) Is any piece hanging?
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- PUZZLE -->
        <div class="card pad view" id="view-puzzle" style="display:none">
          <div class="sectionTitle">
            <div>
              <h2>Daily Puzzle</h2>
              <p>Pick the best move and learn the idea.</p>
            </div>
            <button class="btn" id="btnNewPuzzle">Shuffle puzzle</button>
          </div>

          <div class="row" style="margin-top:14px">
            <div>
              <div class="board" id="board"></div>
              <div class="muted" style="margin-top:10px;font-size:12px">
                FEN: <span class="mono" id="fenText"></span>
              </div>
            </div>
            <div>
              <div class="notice" id="puzzlePrompt"></div>

              <div class="choices" id="choices"></div>

              <div class="hr"></div>
              <div id="puzzleResult" class="notice" style="display:none"></div>

              <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
                <button class="btn primary" id="btnMarkDone">Mark session done</button>
                <button class="btn" id="btnReveal">Reveal explanation</button>
              </div>

              <div class="hr"></div>
              <div class="muted" style="font-size:12px;line-height:1.5">
                <b>AI hook idea:</b> later, you can plug in Stockfish or an LLM to generate
                ‚Äúwhy this works‚Äù explanations and follow-up puzzles.
              </div>
            </div>
          </div>
        </div>

        <!-- PLAN -->
        <div class="card pad view" id="view-plan" style="display:none">
          <div class="sectionTitle">
            <div>
              <h2>Study Plan</h2>
              <p>A realistic weekly plan you can follow.</p>
            </div>
          </div>

          <div class="row" style="margin-top:14px">
            <div>
              <label>Your rating (approx.)</label>
              <input id="planRating" type="number" min="100" max="3500" value="1200" />
              <div style="height:10px"></div>
              <label>Minutes per day you can commit</label>
              <select id="planMinutes">
                <option value="10">10 minutes/day</option>
                <option value="20" selected>20 minutes/day</option>
                <option value="30">30 minutes/day</option>
                <option value="45">45 minutes/day</option>
                <option value="60">60 minutes/day</option>
              </select>
              <div style="height:10px"></div>
              <label>Main goal</label>
              <select id="planGoal">
                <option>Climb rapid rating</option>
                <option>Improve tactics</option>
                <option>Better endgames</option>
                <option>Fix openings</option>
                <option>Stop blundering</option>
              </select>
              <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
                <button class="btn primary" id="btnGeneratePlan">Generate plan</button>
                <button class="btn" id="btnSavePlan">Save plan</button>
              </div>
            </div>

            <div>
              <b>Your weekly plan</b>
              <div class="notice" style="margin-top:10px" id="planOut">Fill the form and generate a plan.</div>
              <div class="hr"></div>
              <div class="muted" style="font-size:12px;line-height:1.5">
                <b>AI hook idea:</b> import a user‚Äôs last 10 games (PGN) and automatically
                choose drills for their most common mistakes.
              </div>
            </div>
          </div>
        </div>

        <!-- OPENINGS -->
        <div class="card pad view" id="view-openings" style="display:none">
          <div class="sectionTitle">
            <div>
              <h2>Opening Flashcards</h2>
              <p>Spaced repetition for key ideas (not memorizing 20 moves deep).</p>
            </div>
            <button class="btn" id="btnNextCard">Next card</button>
          </div>

          <div class="row" style="margin-top:14px">
            <div>
              <label>Add a flashcard (name ‚Üí idea)</label>
              <input id="cardName" placeholder="Example: Italian Game ‚Äî Plan" />
              <div style="height:10px"></div>
              <textarea id="cardIdea" placeholder="Example: Develop fast, aim for d4, watch for tactics on f7."></textarea>
              <div style="display:flex;gap:10px;margin-top:10px">
                <button class="btn primary" id="btnAddCard">Add</button>
                <button class="btn" id="btnClearCards">Clear all</button>
              </div>
            </div>

            <div>
              <b>Current card</b>
              <div class="notice" style="margin-top:10px" id="cardView">No cards yet. Add your first card.</div>

              <div class="hr"></div>
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn" id="btnCardEasy">‚úÖ Easy</button>
                <button class="btn" id="btnCardHard">üò§ Hard</button>
              </div>

              <div class="hr"></div>
              <div class="muted" style="font-size:12px;line-height:1.5">
                <b>AI hook idea:</b> generate flashcards automatically from a user‚Äôs chosen repertoire
                (e.g., ‚ÄúCaro-Kann vs e4‚Äù) with plans and common traps.
              </div>
            </div>
          </div>
        </div>

        <!-- SETTINGS -->
        <div class="card pad view" id="view-settings" style="display:none">
          <div class="sectionTitle">
            <div>
              <h2>Settings</h2>
              <p>Customize your profile for better training.</p>
            </div>
          </div>

          <div class="row" style="margin-top:14px">
            <div>
              <label>Name</label>
              <input id="setName" placeholder="Your name" />
              <div style="height:10px"></div>
              <label>Rating</label>
              <input id="setRating" type="number" min="100" max="3500" />
              <div style="height:10px"></div>
              <label>Main goal</label>
              <input id="setGoal" placeholder="Example: Improve tactics and stop blundering" />
              <div style="display:flex;gap:10px;margin-top:12px">
                <button class="btn primary" id="btnSaveProfile">Save</button>
              </div>
            </div>

            <div>
              <div class="notice">
                <b>Next step (real startup move):</b><br/>
                Add accounts + subscription. Then integrate:
                <ul style="margin:8px 0 0 18px;color:rgba(233,238,252,.9)">
                  <li>Lichess puzzles API for endless tactics</li>
                  <li>Stockfish evaluation for ‚Äúbest move‚Äù</li>
                  <li>Game import (PGN) ‚Üí mistake categories ‚Üí drills</li>
                </ul>
              </div>

              <div class="hr"></div>
              <button class="btn" id="btnExport">Export my data (JSON)</button>
              <button class="btn" id="btnImport" style="margin-top:10px">Import data (JSON)</button>
              <input id="importFile" type="file" accept="application/json" style="display:none" />
            </div>
          </div>
        </div>

      </main>
    </section>

    <div class="footer">
      Built as a starter MVP. You can deploy this as a static site (Netlify/Vercel/GitHub Pages).
    </div>
  </div>

  <script>
    // ----------------------------
    // Simple MVP state + storage
    // ----------------------------
    const STORE_KEY = "climbchess_mvp_v1";
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    const defaultState = () => ({
      profile: { name: "Guest", rating: 1200, goal: "Improve tactics & endgames" },
      stats: { sessionsThisWeek: 0, puzzleAttempts: 0, puzzleCorrect: 0, streak: 0, lastSessionDate: "" },
      notes: "",
      savedPlan: "",
      cards: [],
      cardIndex: 0,
      cardDue: {}, // name -> nextDue timestamp
      puzzleIndex: 0,
      puzzleAnsweredToday: false,
      lastPuzzleDate: ""
    });

    function loadState(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        return raw ? { ...defaultState(), ...JSON.parse(raw) } : defaultState();
      } catch {
        return defaultState();
      }
    }
    function saveState(){
      localStorage.setItem(STORE_KEY, JSON.stringify(state));
      renderAll();
    }
    function todayISO(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    let state = loadState();

    // ----------------------------
    // Views
    // ----------------------------
    function showApp(){
      $("#landing").style.display = "none";
      $("#app").style.display = "grid";
      $("#modePill").textContent = "Demo App";
      showView("dashboard");
      renderAll();
    }
    function showLanding(){
      $("#landing").style.display = "";
      $("#app").style.display = "none";
      $("#modePill").textContent = "Landing";
    }
    function showView(name){
      $$(".view").forEach(v => v.style.display = "none");
      $(`#view-${name}`).style.display = "";
      // highlight
      $$(".menu .btn").forEach(b => b.style.background = "");
      const btn = $(`.menu .btn[data-view="${name}"]`);
      if(btn) btn.style.background = "rgba(255,255,255,.10)";
      renderAll();
    }

    // ----------------------------
    // Puzzle data (simple, offline)
    // Each puzzle: FEN + prompt + choices + answer + explanation
    // NOTE: Choices are SAN-ish text; this MVP does NOT validate legality.
    // Later you can plug in Stockfish + real move generation.
    // ----------------------------
    const puzzles = [
      {
        fen: "r1bqkbnr/pppp1ppp/2n5/4p3/2B1P3/5N2/PPPP1PPP/RNBQK2R w KQkq - 2 3",
        prompt: "White to move: punish Black‚Äôs early ...e5 with a tactical strike.",
        choices: ["Bxf7+", "Nc3", "d3", "O-O"],
        answer: "Bxf7+",
        explain: "Bxf7+ is a classic fork idea: it drags the king and can win tempo or the queen depending on Black‚Äôs reply. The key habit: look for checks first."
      },
      {
        fen: "r2q1rk1/ppp2ppp/2np1n2/4p3/2B1P3/2NP1N2/PPP2PPP/R1BQ1RK1 w - - 0 7",
        prompt: "White to move: build a strong center and open lines for an attack.",
        choices: ["d4", "Bg5", "h3", "Be3"],
        answer: "d4",
        explain: "d4 hits the center, gains space, and challenges Black‚Äôs e5. Strong players improve by linking tactics to strategy: center control creates future tactics."
      },
      {
        fen: "8/6pk/5p2/5P2/6P1/6K1/8/8 w - - 0 1",
        prompt: "White to move: simple endgame technique‚Äîconvert the pawn.",
        choices: ["f6+", "Kf4", "g5", "Kh4"],
        answer: "f6+",
        explain: "f6+ forces the king back and clears the path for promotion. Endgames reward calculation + fundamentals: push passed pawns with tempo."
      },
      {
        fen: "r1bqkb1r/ppp2ppp/2n2n2/3pp3/2B1P3/2NP1N2/PPP2PPP/R1BQK2R w KQkq - 0 5",
        prompt: "White to move: choose the best developing move that keeps pressure.",
        choices: ["Bg5", "O-O", "exd5", "Nxe5"],
        answer: "O-O",
        explain: "Castle early when it‚Äôs safe‚Äîespecially in open centers. Many players stall castling and get hit by tactics. King safety is a rating booster."
      }
    ];

    // ----------------------------
    // FEN renderer (board only)
    // ----------------------------
    const pieceMap = {
      p:"‚ôü", r:"‚ôú", n:"‚ôû", b:"‚ôù", q:"‚ôõ", k:"‚ôö",
      P:"‚ôô", R:"‚ôñ", N:"‚ôò", B:"‚ôó", Q:"‚ôï", K:"‚ôî"
    };
    function renderBoard(fen){
      const boardEl = $("#board");
      boardEl.innerHTML = "";
      const [placement] = fen.split(" ");
      const rows = placement.split("/");
      for(let r=0;r<8;r++){
        let file = 0;
        for(const ch of rows[r]){
          if(/[1-8]/.test(ch)){
            const n = Number(ch);
            for(let i=0;i<n;i++){
              boardEl.appendChild(makeSquare(r,file,""));
              file++;
            }
          } else {
            boardEl.appendChild(makeSquare(r,file,pieceMap[ch] || ""));
            file++;
          }
        }
      }
    }
    function makeSquare(r,f,content){
      const sq = document.createElement("div");
      sq.className = "sq " + (((r+f)%2) ? "dark":"");
      sq.textContent = content;
      // coordinates a1..h8 labels on edge squares
      const rank = 8 - r;
      const fileChar = String.fromCharCode("a".charCodeAt(0) + f);
      const show = (r===7 || f===0);
      if(show){
        const c = document.createElement("div");
        c.className = "coord";
        c.textContent = (f===0 ? rank : "") + (r===7 ? fileChar : "");
        sq.appendChild(c);
      }
      return sq;
    }

    // ----------------------------
    // Puzzle UI
    // ----------------------------
    function loadPuzzle(index){
      const p = puzzles[index % puzzles.length];
      $("#fenText").textContent = p.fen;
      $("#puzzlePrompt").textContent = p.prompt;
      $("#puzzleResult").style.display = "none";
      $("#puzzleResult").className = "notice";
      renderBoard(p.fen);

      const choicesEl = $("#choices");
      choicesEl.innerHTML = "";
      p.choices.forEach(move => {
        const c = document.createElement("div");
        c.className = "choice";
        c.textContent = move;
        c.onclick = () => chooseMove(move);
        choicesEl.appendChild(c);
      });

      // store current puzzle on element dataset
      choicesEl.dataset.answer = p.answer;
      choicesEl.dataset.explain = p.explain;
      state.puzzleIndex = index % puzzles.length;
      saveState();
    }

    function chooseMove(move){
      const choicesEl = $("#choices");
      const answer = choicesEl.dataset.answer;
      const explain = choicesEl.dataset.explain;

      // prevent double counting: only count first attempt per puzzle screen
      if(choicesEl.dataset.locked === "1") return;
      choicesEl.dataset.locked = "1";

      state.stats.puzzleAttempts += 1;
      const correct = (move === answer);
      if(correct) state.stats.puzzleCorrect += 1;

      $$("#choices .choice").forEach(el => {
        if(el.textContent === answer) el.classList.add("correct");
        if(el.textContent === move && !correct) el.classList.add("wrong");
        el.style.pointerEvents = "none";
      });

      const out = $("#puzzleResult");
      out.style.display = "";
      out.className = "notice " + (correct ? "good":"bad");
      out.innerHTML = correct
        ? `<b>Correct.</b> ${explain}`
        : `<b>Not quite.</b> Best is <span class="mono">${answer}</span>.<br/>${explain}`;

      saveState();
    }

    function revealExplanation(){
      const choicesEl = $("#choices");
      const answer = choicesEl.dataset.answer;
      const explain = choicesEl.dataset.explain;
      const out = $("#puzzleResult");
      out.style.display = "";
      out.className = "notice";
      out.innerHTML = `<b>Explanation:</b> Best is <span class="mono">${answer}</span>.<br/>${explain}`;
    }

    // ----------------------------
    // Study plan generator (simple heuristic)
    // ----------------------------
    function generatePlan(rating, minutes, goal){
      const m = Number(minutes);
      const r = Number(rating);
      const focus = (goal || "").toLowerCase();

      // weights by rating band
      let tactics = 0.35, endgames = 0.20, openings = 0.20, review = 0.25;
      if(r < 1000){ tactics = 0.45; endgames = 0.20; openings = 0.10; review = 0.25; }
      else if(r < 1400){ tactics = 0.40; endgames = 0.20; openings = 0.15; review = 0.25; }
      else if(r < 1800){ tactics = 0.35; endgames = 0.25; openings = 0.15; review = 0.25; }
      else { tactics = 0.30; endgames = 0.25; openings = 0.20; review = 0.25; }

      // adjust for goal
      if(focus.includes("tactic")) { tactics += 0.10; openings -= 0.05; }
      if(focus.includes("endgame")) { endgames += 0.10; openings -= 0.05; }
      if(focus.includes("opening")) { openings += 0.10; tactics -= 0.05; }
      if(focus.includes("blunder")) { review += 0.10; openings -= 0.05; }

      // normalize
      const sum = tactics+endgames+openings+review;
      tactics/=sum; endgames/=sum; openings/=sum; review/=sum;

      const t = Math.max(5, Math.round(m*tactics));
      const e = Math.max(5, Math.round(m*endgames));
      const o = Math.max(5, Math.round(m*openings));
      const g = Math.max(5, m - t - e - o);

      const days = [
        ["Mon", `Tactics ${t}m + Game review ${g}m`],
        ["Tue", `Endgames ${e}m + Tactics ${Math.max(5, m-e)}m`],
        ["Wed", `Openings ${o}m + Tactics ${Math.max(5, m-o)}m`],
        ["Thu", `Tactics ${t}m + Endgames ${Math.max(5, m-t)}m`],
        ["Fri", `Game review ${g}m + Tactics ${Math.max(5, m-g)}m`],
        ["Sat", `Play 2 rapid games + review 1 game (key blunders)`],
        ["Sun", `Light day: openings ideas + one endgame (30‚Äì45m total)`]
      ];

      const header = `Plan for ~${r} rating ‚Ä¢ ${m} min/day ‚Ä¢ Goal: ${goal}`;
      const lines = days.map(([d, s]) => `<b>${d}</b>: ${s}`).join("<br/>");
      const principle = `<div class="hr"></div><b>Rule:</b> never do more than you can repeat daily. Consistency beats marathon sessions.`;
      return `<b>${header}</b><div class="hr"></div>${lines}${principle}`;
    }

    // ----------------------------
    // Openings flashcards (simple spaced repetition)
    // ----------------------------
    function addCard(name, idea){
      if(!name.trim() || !idea.trim()) return;
      state.cards.push({ name: name.trim(), idea: idea.trim() });
      saveState();
      showCard(state.cards.length-1);
    }
    function showCard(idx){
      if(state.cards.length === 0){
        $("#cardView").innerHTML = "No cards yet. Add your first card.";
        return;
      }
      state.cardIndex = ((idx % state.cards.length) + state.cards.length) % state.cards.length;
      const c = state.cards[state.cardIndex];
      $("#cardView").innerHTML = `<b>${escapeHtml(c.name)}</b><div class="hr"></div>${escapeHtml(c.idea)}`;
    }
    function escapeHtml(s){
      return s.replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }

    function cardRate(hard){
      if(state.cards.length === 0) return;
      const c = state.cards[state.cardIndex];
      const now = Date.now();
      const wait = hard ? (6*60*60*1000) : (24*60*60*1000); // 6h vs 24h
      state.cardDue[c.name] = now + wait;
      saveState();
      // move to next due
      nextCard();
    }
    function nextCard(){
      if(state.cards.length === 0) return;
      const now = Date.now();
      // find any due card; else just cycle
      let dueIndex = -1;
      for(let i=0;i<state.cards.length;i++){
        const c = state.cards[i];
        const due = state.cardDue[c.name] || 0;
        if(due <= now){ dueIndex = i; break; }
      }
      showCard(dueIndex >= 0 ? dueIndex : (state.cardIndex+1));
    }

    // ----------------------------
    // Session/streak logic
    // ----------------------------
    function markSessionDone(){
      const today = todayISO();
      const last = state.stats.lastSessionDate;
      if(last === today) return; // already marked today

      state.stats.sessionsThisWeek += 1;

      // streak logic: if yesterday => +1 else reset to 1
      const dToday = new Date(today);
      const dLast = last ? new Date(last) : null;
      if(dLast){
        const diffDays = Math.round((dToday - dLast) / (1000*60*60*24));
        state.stats.streak = (diffDays === 1) ? (state.stats.streak + 1) : 1;
      } else {
        state.stats.streak = 1;
      }
      state.stats.lastSessionDate = today;
      saveState();
    }

    // ----------------------------
    // Rendering
    // ----------------------------
    function renderAll(){
      // sidebar
      $("#userName").textContent = state.profile.name || "Guest";
      $("#userRatingTag").textContent = `rating: ${state.profile.rating || 1200}`;
      $("#userGoal").textContent = `Goal: ${state.profile.goal || "Improve"}`;
      $("#streakTag").textContent = `streak: ${state.stats.streak || 0}`;

      // dashboard KPIs
      const attempts = state.stats.puzzleAttempts || 0;
      const correct = state.stats.puzzleCorrect || 0;
      const acc = attempts ? Math.round((correct/attempts)*100) : 0;
      $("#kpiAccuracy").textContent = attempts ? `${acc}%` : "‚Äî";
      $("#kpiSessions").textContent = String(state.stats.sessionsThisWeek || 0);

      // notes
      $("#notes").value = state.notes || "";

      // saved plan
      if(state.savedPlan){
        $("#planOut").innerHTML = state.savedPlan;
      }

      // today focus suggestion
      const focus = (acc < 60 && attempts >= 3)
        ? "Today: slow down. Before moving, scan checks/captures/threats and ensure nothing is hanging."
        : (state.stats.streak >= 3)
          ? "Today: keep the streak alive‚Äîone puzzle + one endgame pattern is enough."
          : "Today: do the daily puzzle, then review one blunder from a recent game.";
      $("#todayFocus").textContent = focus;

      // openings card
      showCard(state.cardIndex || 0);

      // settings inputs
      $("#setName").value = state.profile.name || "";
      $("#setRating").value = state.profile.rating || 1200;
      $("#setGoal").value = state.profile.goal || "";
      $("#planRating").value = state.profile.rating || 1200;
    }

    // ----------------------------
    // Events
    // ----------------------------
    $("#btnStart").onclick = showApp;
    $("#btnStart2").onclick = showApp;
    $("#btnDemo").onclick = showApp;
    $("#btnBack").onclick = showLanding;

    $$(".menu .btn[data-view]").forEach(b => {
      b.onclick = () => showView(b.dataset.view);
    });

    $("#btnQuickPuzzle").onclick = () => showView("puzzle");

    $("#btnNewPuzzle").onclick = () => {
      const idx = Math.floor(Math.random() * puzzles.length);
      $("#choices").dataset.locked = "0";
      loadPuzzle(idx);
      // re-enable clicks
      $$("#choices .choice").forEach(el => el.style.pointerEvents = "");
    };

    $("#btnReveal").onclick = revealExplanation;

    $("#btnMarkDone").onclick = () => {
      markSessionDone();
      const out = $("#puzzleResult");
      out.style.display = "";
      out.className = "notice good";
      out.innerHTML = `<b>Session saved.</b> Nice. Come back tomorrow for consistency.`;
    };

    $("#btnGeneratePlan").onclick = () => {
      const rating = $("#planRating").value;
      const minutes = $("#planMinutes").value;
      const goal = $("#planGoal").value;
      $("#planOut").innerHTML = generatePlan(rating, minutes, goal);
    };

    $("#btnSavePlan").onclick = () => {
      state.savedPlan = $("#planOut").innerHTML;
      saveState();
    };

    $("#btnSaveNotes").onclick = () => {
      state.notes = $("#notes").value;
      saveState();
    };
    $("#btnClearNotes").onclick = () => {
      state.notes = "";
      saveState();
    };

    $("#btnAddCard").onclick = () => {
      addCard($("#cardName").value, $("#cardIdea").value);
      $("#cardName").value = "";
      $("#cardIdea").value = "";
    };
    $("#btnNextCard").onclick = nextCard;
    $("#btnCardEasy").onclick = () => cardRate(false);
    $("#btnCardHard").onclick = () => cardRate(true);
    $("#btnClearCards").onclick = () => {
      state.cards = [];
      state.cardDue = {};
      state.cardIndex = 0;
      saveState();
    };

    $("#btnSaveProfile").onclick = () => {
      state.profile.name = $("#setName").value.trim() || "Guest";
      state.profile.rating = Number($("#setRating").value) || 1200;
      state.profile.goal = $("#setGoal").value.trim() || "Improve";
      saveState();
    };

    $("#btnReset").onclick = () => {
      state = defaultState();
      saveState();
      alert("Demo data reset.");
    };

    $("#btnPitch").onclick = () => {
      alert(
`ClimbChess Pitch (MVP):
‚Ä¢ Hook: ‚ÄúDaily puzzle + explanation + streak‚Äù keeps people consistent.
‚Ä¢ Expansion: Import games ‚Üí detect recurring mistakes ‚Üí personalized drills.
‚Ä¢ Monetization: $8‚Äì15/mo subscription + coach marketplace later.`
      );
    };

    // Export / Import
    $("#btnExport").onclick = () => {
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "climbchess-data.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };
    $("#btnImport").onclick = () => $("#importFile").click();
    $("#importFile").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const imported = JSON.parse(text);
        state = { ...defaultState(), ...imported };
        saveState();
        alert("Imported successfully.");
      } catch {
        alert("Import failed. Make sure it's valid JSON exported from this app.");
      } finally {
        e.target.value = "";
      }
    });

    // Initialize puzzle on first app open
    function initPuzzleIfNeeded(){
      $("#choices").dataset.locked = "0";
      loadPuzzle(state.puzzleIndex || 0);
      $$("#choices .choice").forEach(el => el.style.pointerEvents = "");
    }

    // When app becomes visible, load puzzle + render
    const originalShowApp = showApp;
    showApp = function(){
      originalShowApp();
      initPuzzleIfNeeded();
    }

    // Start state
    renderAll();
  </script>
</body>
</html>